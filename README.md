# ComfyUI-Blender Bridge (èŠ‚ç‚¹ç«¯)

è¿™æ˜¯ä¸€ä¸ªä¸º [ComfyUI](https://github.com/comfyanonymous/ComfyUI) è®¾è®¡çš„èŠ‚ç‚¹åŒ…ï¼Œå®ƒå……å½“äº†ä¸ Blender æ’ä»¶é€šä¿¡çš„æœåŠ¡å™¨ç«¯æ¡¥æ¢ï¼Œå®ç°äº† Blender å’Œ ComfyUI ä¹‹é—´ç¨³å®šã€é«˜æ•ˆã€å®æ—¶çš„åŒå‘é€šä¿¡ã€‚

è¿™ä¸ªé¡¹ç›®æ˜¯ **Blender-ComfyUI Bridge** ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ï¼Œè´Ÿè´£åœ¨ ComfyUI å†…éƒ¨æ¥æ”¶ä»»åŠ¡ã€è§£ææ•°æ®ï¼Œå¹¶å°†å¤„ç†ç»“æœå‘é€å› Blenderã€‚è¦å®Œæ•´ä½¿ç”¨æ­¤ç³»ç»Ÿï¼Œæ‚¨è¿˜éœ€è¦åœ¨ Blender ä¸­å®‰è£…å¯¹åº”çš„[å®¢æˆ·ç«¯æ’ä»¶](https://github.com/ageless-h/Blender-ComfyUI-Bridge)ã€‚

## âœ¨ åŠŸèƒ½ç‰¹æ€§ (èŠ‚ç‚¹ç«¯)

*   **äº¤äº’å¼å·¥ä½œæµé›†æˆ**: èŠ‚ç‚¹ä»¥äº¤äº’æ¨¡å¼è¿è¡Œï¼Œå®æ—¶æ¥æ”¶ Blender å‘é€çš„å›¾åƒå’Œå…ƒæ•°æ®ï¼Œå¹¶é€šè¿‡ `DataHub` èŠ‚ç‚¹å°†å…¶åˆ†è§£ä¸ºå¤šä¸ªæ¸²æŸ“é€šé“ï¼Œä¾›æ‚¨åœ¨ ComfyUI ä¸­è‡ªç”±æ„å»ºå’Œè¯•éªŒå·¥ä½œæµã€‚
*   **å¼ºå¤§çš„ EXR æ•°æ®è§£æ**:
    *   **å¤šé€šé“ EXR æ”¯æŒ**: `DataHub` èŠ‚ç‚¹å¯ä»¥è§£æå¤šå±‚ EXR æ–‡ä»¶ï¼Œå°†æ‰€æœ‰æ¸²æŸ“é€šé“ï¼ˆå¦‚ `Depth`, `Mist`, `Normal`, `AO`, `Diffuse Color` ç­‰ï¼‰åˆ†ç¦»æˆç‹¬ç«‹çš„å›¾åƒè¾“å‡ºã€‚
    *   **åŠ¨æ€é€šé“æ˜ å°„ (`channel_map`)**: èŠ‚ç‚¹ä¸ç¡¬ç¼–ç é€šé“åç§°ï¼Œè€Œæ˜¯æ ¹æ® Blender æ’ä»¶å‘é€çš„ `channel_map` å…ƒæ•°æ®åŠ¨æ€æŸ¥æ‰¾ï¼Œæä¾›äº†æé«˜çš„çµæ´»æ€§å’Œå…¼å®¹æ€§ã€‚
*   **å¥å£®çš„é€šä¿¡åè®®**:
    *   **Blender -> ComfyUI**: ä½¿ç”¨ **ZMQ (REP/REQ)** æ¥æ”¶æ¥è‡ª Blender çš„å¤šéƒ¨åˆ†æ¶ˆæ¯ï¼ˆå…ƒæ•°æ® + å›¾åƒäºŒè¿›åˆ¶æ•°æ®ï¼‰ã€‚
    *   **ComfyUI -> Blender**: ä½¿ç”¨ **HTTP** å°†å¤„ç†å®Œæˆçš„å›¾åƒæ•°æ®å‘é€å› Blenderã€‚
*   **æ™ºèƒ½æ•°æ®è¿”å›**:
    *   `Sender` èŠ‚ç‚¹èƒ½å¤Ÿåˆ¤æ–­ Blender çš„ä½ç½®ã€‚å¦‚æœæ˜¯åœ¨æœ¬æœºï¼Œå®ƒä¼šé€šè¿‡å…±äº«æ–‡ä»¶è·¯å¾„çš„æ–¹å¼è¿”å›ç»“æœï¼Œé€Ÿåº¦æå¿«ï¼›å¦‚æœæ˜¯è¿œç¨‹ï¼Œåˆ™ä¼šé€šè¿‡ç½‘ç»œå‘é€å›¾åƒçš„äºŒè¿›åˆ¶æ•°æ®ï¼Œå…¼å®¹è·¨è®¾å¤‡éƒ¨ç½²ã€‚
*   **å®æ—¶è¿æ¥æµ‹è¯•**:
    *   å†…ç½® `ping/pong` æœºåˆ¶ï¼Œæ–¹ä¾¿ Blender æ’ä»¶æµ‹è¯•ä¸ ComfyUI æœåŠ¡å™¨çš„è¿æ¥çŠ¶æ€ã€‚
*   **ä¾èµ–é¡¹æ£€æŸ¥**: èŠ‚ç‚¹ä¼šè‡ªåŠ¨æ£€æµ‹ `OpenEXR-python` ä¾èµ–æ˜¯å¦å­˜åœ¨ï¼Œå¹¶åœ¨ç¼ºå¤±æ—¶ç»™å‡ºæ˜ç¡®çš„å®‰è£…æç¤ºã€‚

## ğŸš€ å®‰è£…æŒ‡å—

1.  **å…‹éš†æˆ–ä¸‹è½½æœ¬ä»“åº“**:
    ```bash
    cd ComfyUI/custom_nodes/
    git clone https://github.com/ageless-h/ComfyUI-Blender-Bridge-node.git
    ```
    æˆ–è€…ï¼Œä» GitHub ä¸‹è½½ ZIP å‹ç¼©åŒ…å¹¶è§£å‹åˆ° `ComfyUI/custom_nodes/` ç›®å½•ä¸‹ã€‚

2.  **å®‰è£…ä¾èµ–é¡¹**:
    ä¸ºäº†å®Œæ•´æ”¯æŒ EXR å¤šé€šé“åŠŸèƒ½ï¼Œæ‚¨éœ€è¦å®‰è£… `OpenEXR-python`ã€‚è¯·åœ¨æ‚¨çš„ ComfyUI Python ç¯å¢ƒä¸­è¿è¡Œï¼š
    ```bash
    pip install OpenEXR-python msgspec
    ```
    *   `OpenEXR-python`: ç”¨äºè§£æ EXR æ–‡ä»¶ã€‚
    *   `msgspec`: ç”¨äºé«˜æ•ˆåœ°å¤„ç† ZMQ æ¶ˆæ¯ä¸­çš„å…ƒæ•°æ®ã€‚

3.  **é‡å¯ ComfyUI**:
    é‡å¯ ComfyUIï¼Œæ‚¨åº”è¯¥èƒ½åœ¨èŠ‚ç‚¹èœå•çš„ `Blender Bridge` åˆ†ç±»ä¸‹æ‰¾åˆ°ä»¥ä¸‹èŠ‚ç‚¹ï¼š
    *   **Receiver**: å¯åŠ¨ ZMQ æœåŠ¡å™¨ï¼Œæ¥æ”¶ Blender æ•°æ®ã€‚æ˜¯ä¸€åˆ‡æµç¨‹çš„èµ·ç‚¹ã€‚
    *   **DataHub**: ï¼ˆå·¥ä½œæµæ ¸å¿ƒï¼‰è§£ææ”¶åˆ°çš„æ•°æ®ï¼Œç‰¹åˆ«æ˜¯å°† EXR åˆ†è§£ä¸ºå¤šä¸ªæ¸²æŸ“é€šé“ã€‚
    *   **Sender**: å°†æœ€ç»ˆçš„å›¾åƒç»“æœé€šè¿‡ HTTP å‘é€å› Blenderã€‚

## ğŸ”§ ä½¿ç”¨æ–¹æ³•

æœ¬èŠ‚ç‚¹åŒ…ä¸“æ³¨äºæä¾›ä¸€ä¸ªçµæ´»çš„äº¤äº’å¼å·¥ä½œæµã€‚

1.  åœ¨ ComfyUI ä¸­ï¼ŒæŒ‰ä»¥ä¸‹é¡ºåºè¿æ¥èŠ‚ç‚¹ï¼š
    `Receiver` -> `DataHub` -> ... (æ‚¨çš„å›¾åƒå¤„ç†èŠ‚ç‚¹) ... -> `Sender`

2.  ä» `DataHub` çš„å„ä¸ªè¾“å‡ºç«¯å£ï¼ˆ`image`, `depth`, `normal` ç­‰ï¼‰æ‹‰å‡ºæ‚¨éœ€è¦çš„æ¸²æŸ“é€šé“ï¼Œå°†å®ƒä»¬ç”¨ä½œæ‚¨å·¥ä½œæµçš„è¾“å…¥ã€‚

3.  å°†æ‚¨æœ€ç»ˆå¤„ç†å¥½çš„å›¾åƒè¿æ¥åˆ° `Sender` èŠ‚ç‚¹çš„ `image` è¾“å…¥ç«¯å£ã€‚

4.  åœ¨ Blender æ’ä»¶ä¸­å‘é€å›¾åƒã€‚å›¾åƒå’Œæ•°æ®ä¼šå‡ºç°åœ¨æ‚¨çš„ ComfyUI å·¥ä½œæµä¸­ï¼Œå¤„ç†å®Œæˆåç»“æœä¼šè‡ªåŠ¨è¿”å› Blenderã€‚

---

## ğŸ’» æŠ€æœ¯å®ç°ç»†èŠ‚ (ä¾›å¼€å‘è€…å‚è€ƒ)

### ZMQ æ¶ˆæ¯ç»“æ„

èŠ‚ç‚¹æ¥æ”¶åˆ°çš„ ZMQ æ¶ˆæ¯åŒ…å« **2** ä¸ªéƒ¨åˆ†ï¼š

1.  **Part 1: å…ƒæ•°æ® (Metadata)**
    *   **ç±»å‹**: `msgspec` ç¼–ç çš„å­—å…¸ã€‚
    *   **å†…å®¹**: åŒ…å«å›¾åƒä¿¡æ¯ (`render_type`) å’Œè¿”å›åœ°å€ (`return_info`) ç­‰ã€‚

2.  **Part 2: å›¾åƒäºŒè¿›åˆ¶æ•°æ® (Image Bytes)**
    *   **ç±»å‹**: åŸå§‹å­—èŠ‚æµ (`bytes`)ã€‚
    *   **å†…å®¹**: `.png` æˆ– `.exr` æ–‡ä»¶çš„å®Œæ•´äºŒè¿›åˆ¶å†…å®¹ã€‚

**æ¥æ”¶é€»è¾‘ (`receiver.py`) å¿…é¡»ä½¿ç”¨ `socket.recv_multipart()` æ¥æ­£ç¡®è§£æè¿™ä¸¤ä¸ªéƒ¨åˆ†ã€‚**

### å…³é”®å…ƒæ•°æ®å­—æ®µ

*   `render_type` (å­—ç¬¦ä¸²): `'standard'` æˆ– `'multilayer_exr'`ã€‚`DataHub` èŠ‚ç‚¹æ ¹æ®æ­¤å­—æ®µå†³å®šè§£æé€»è¾‘ã€‚
*   `channel_map` (å­—å…¸): ä»…åœ¨ `render_type` ä¸º `'multilayer_exr'` æ—¶æä¾›ã€‚ç”¨äºå°† ComfyUI çš„é€šé“å (key) æ˜ å°„åˆ° EXR æ–‡ä»¶ä¸­å®é™…çš„é€šé“å (value)ã€‚
*   `return_info` (å­—å…¸): åŒ…å« Blender HTTP æœåŠ¡å™¨çš„åœ°å€ (`blender_server_address`) å’Œç›®æ ‡å›¾åƒæ•°æ®å—çš„åç§° (`image_datablock_name`)ï¼Œä¾› `Sender` èŠ‚ç‚¹ä½¿ç”¨ã€‚ 